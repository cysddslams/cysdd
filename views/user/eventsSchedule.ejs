<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events Schedule</title>
    <link rel="stylesheet" href="/styles/frontpage.css">
    <link rel="stylesheet" href="/styles/userEvents.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
    <style>
        .schedule-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #007bff;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        .event-hero {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .event-hero h1 {
            margin: 0 0 10px 0;
            font-size: 2.2rem;
        }

        .event-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .brackets-section {
            margin-bottom: 40px;
        }

        .section-title {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }

        .brackets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .bracket-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .bracket-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, #28a745, #1e7e34);
        }

        .bracket-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .bracket-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .bracket-info {
            color: #666;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bracket-info i {
            color: #007bff;
            width: 16px;
        }

        .bracket-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-ongoing {
            background: #fff3cd;
            color: #856404;
        }

        .matches-section {
            display: none;
            margin-top: 30px;
        }

        .matches-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }

        .bracket-header {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .bracket-header h3 {
            margin: 0 0 10px 0;
            font-size: 1.5rem;
        }

        .round {
            margin-bottom: 35px;
        }

        .round-header {
            background: #007bff;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .match-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .match-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .teams-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .team {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-weight: 600;
            color: #333;
        }

        .user-team {
            background: #e3f2fd;
            border: 2px solid #007bff;
            border-radius: 6px;
        }

        .vs {
            margin: 0 15px;
            font-weight: bold;
            color: #666;
            background: #fff;
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid #ddd;
        }

        .match-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 0.9rem;
        }

        .score-display {
            background: #e9ecef;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        .winner-display {
            background: #d4edda;
            color: #155724;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
        }

        .no-brackets {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-brackets i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ddd;
        }

        .no-brackets h3 {
            color: #333;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .brackets-grid {
                grid-template-columns: 1fr;
            }
            
            .teams-display {
                flex-direction: column;
                gap: 10px;
            }
            
            .vs {
                margin: 10px 0;
            }
            
            .event-meta {
                flex-direction: column;
                gap: 10px;
            }
            
            .match-info {
                grid-template-columns: 1fr;
            }
        }

    </style>
</head>
<body>

    <!-- Sidebar Menu -->
    <div id="mySidebar" class="sidebar">
        <a href="/homepage"><i class="fas fa-home"></i> Home</a>
        <a href="/posts"><i class="fas fa-newspaper"></i> Posts</a>
        <a href="/gallery"><i class="fas fa-image"></i> Gallery</a>
        <a href="/events" class="active"><i class="fas fa-calendar-alt"></i> Events</a>
        <!-- Team link with sub-sidebar -->
        <a href="javascript:void(0);" class="team-link" onclick="toggleSubSidebar()"><i class="fas fa-users-cog"></i> Teams</a>
        <div class="sub-sidebar" id="subSidebar">
            <a href="/my-team"><i class="fas fa-user"></i> My Team</a>
            <a href="/join-team"><i class="fas fa-user-plus"></i> Join Team</a>
            <a href="/all-teams"><i class="fas fa-users"></i> All Teams</a>
        </div>
        
    </div>

    <!-- Sidebar toggle button -->
    <span class="sidebar-btn" onclick="toggleNav()">&#9776;</span>

    <header class="header">
        <div class="logo">
            <a href="/homepage" style="text-decoration: none;">
                <img src="/images/cityYouth.jpg" alt="SLAMS Logo">
            </a>
            <span class="slams-title">SLAMS</span>
        </div>

        <div class="user-profile">
            <% if (user.profile) { %>
                <img src="<%= user.profile %>" alt="Profile" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #fff;">
            <% } else { %>
                <i class="fas fa-user-shield" style="font-size: 24px;"></i>
            <% } %>
            
        </div>
    </header>
    <div class="dropdown-content">
                <a href="/profile">
                    <i class="fas fa-cogs" style="margin-right: 8px;"></i> Profile
                </a>
                <a href="javascript:void(0);" class="logout-btn" onclick="showLogoutModal()">
                    <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i> Log Out
                </a>
            </div>

    <main class="schedule-container">
        <!-- Page Header -->
        <div class="page-header">
            <h2 class="page-title"><i class="fas fa-calendar-day"></i> Tournament Schedules</h2>
            <a href="/events" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Events
            </a>
        </div>

        <!-- Event Hero Section -->
        <div class="event-hero">
            <h1><%= event.title %></h1>
            <% if (event.description) { %>
                <p style="margin: 0; opacity: 0.9;"><%= event.description %></p>
            <% } %>
            <div class="event-meta">
                <div class="meta-item">
                    <i class="fas fa-calendar-alt"></i>
                    <%= new Date(event.date_schedule).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
                </div>
                <div class="meta-item">
                    <i class="fas fa-clock"></i>
                    <%= new Date(event.date_schedule).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %>
                </div>
                <div class="meta-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <%= event.location %>
                </div>
            </div>
        </div>

        <!-- Brackets Section -->
        <section class="brackets-section">
            <h3 class="section-title"><i class="fas fa-trophy"></i> Tournament Brackets</h3>
            
            <% if (brackets && brackets.length > 0) { %>
                <div class="brackets-grid" id="bracketsGrid">
                    <% brackets.forEach(bracket => { %>
                        <div class="bracket-card" data-bracket-id="<%= bracket.id %>">
                            <h3><%= bracket.sport_type %></h3>
                            <div class="bracket-info">
                                <i class="fas fa-chess-board"></i>
                                <span><%= bracket.bracket_type.replace('_', ' ').toUpperCase() %> Tournament</span>
                            </div>
                            <div class="bracket-info">
                                <i class="fas fa-flag"></i>
                                <span>Current Round: <%= bracket.current_round || 1 %></span>
                            </div>
                            <div class="bracket-info">
                                <i class="fas fa-calendar"></i>
                                <span>Created: <%= new Date(bracket.created_at).toLocaleDateString() %></span>
                            </div>
                            <% if (bracket.champion_name) { %>
                                <div class="bracket-info">
                                    <i class="fas fa-trophy"></i>
                                    <span>Champion: <%= bracket.champion_name %></span>
                                </div>
                            <% } %>
                            <div class="bracket-status status-<%= bracket.is_completed ? 'completed' : 'ongoing' %>">
                                <%= bracket.is_completed ? 'Completed' : 'In Progress' %>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="no-brackets">
                    <i class="far fa-calendar-times"></i>
                    <h3>No Tournament Schedules Available</h3>
                    <p>Tournament brackets have not been created for this event yet.</p>
                    <p>Check back later for updates.</p>
                </div>
            <% } %>
        </section>

        <!-- Matches Section -->
        <section id="matchesSection" class="matches-section">
            <div class="matches-container">
                <div id="bracketHeader" class="bracket-header">
                    <!-- Dynamic content will be loaded here -->
                </div>
                <div id="matchesContainer">
                    <!-- Dynamic matches will be loaded here -->
                </div>
                <button id="backToBrackets" class="back-btn" style="margin-top: 20px;">
                    <i class="fas fa-arrow-left"></i> Back to Brackets
                </button>
            </div>
        </section>
    </main>

    <!-- Modal for logout confirmation -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <h3>Are you sure you want to log out?</h3>
            <button id="confirmLogout" class="confirm-btn">Confirm</button>
            <button id="cancelLogout" class="cancel-btn">Cancel</button>
        </div>
    </div>

    <script>
        let currentBracketId = null;
            const userTeams = <%= JSON.stringify(userTeams) %>;

            // Bracket card click handler
            document.querySelectorAll('.bracket-card').forEach(card => {
                card.addEventListener('click', function() {
                    const bracketId = this.dataset.bracketId;
                    loadBracketMatches(bracketId);
                });
            });

            // Load bracket matches
            async function loadBracketMatches(bracketId) {
                try {
                    const response = await fetch(`/event-schedule/bracket/${bracketId}/matches`);
                    const data = await response.json();
                    
                    if (data.success) {
                        displayMatches(data.matches, data.bracket);
                        currentBracketId = bracketId;
                        
                        // Show matches section, hide brackets
                        document.getElementById('matchesSection').style.display = 'block';
                        document.querySelector('.brackets-section').style.display = 'none';
                    } else {
                        alert('Error loading bracket matches');
                    }
                } catch (error) {
                    console.error('Error loading matches:', error);
                    alert('Error loading matches');
                }
            }

            // Display matches
            function displayMatches(matches, bracket) {
                // Update bracket header
                const bracketHeader = document.getElementById('bracketHeader');
                bracketHeader.innerHTML = `
                    <h3>${bracket.sport_type} - ${bracket.bracket_type.replace('_', ' ').toUpperCase()} Tournament</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px;">
                        <span><i class="fas fa-flag"></i> Current Round: ${bracket.current_round || 1}</span>
                        <span class="bracket-status status-${bracket.is_completed ? 'completed' : 'ongoing'}">
                            ${bracket.is_completed ? 'Completed' : 'In Progress'}
                        </span>
                        ${bracket.champion_name ? `<span><i class="fas fa-trophy"></i> Champion: ${bracket.champion_name}</span>` : ''}
                    </div>
                `;

                // Group matches by round
                const rounds = {};
                matches.forEach(match => {
                    if (!rounds[match.round_number]) {
                        rounds[match.round_number] = [];
                    }
                    rounds[match.round_number].push(match);
                });

                const matchesContainer = document.getElementById('matchesContainer');
                matchesContainer.innerHTML = '';

                // Display each round
                Object.keys(rounds).sort((a, b) => a - b).forEach(roundNumber => {
                    const roundDiv = document.createElement('div');
                    roundDiv.className = 'round';
                    roundDiv.innerHTML = `<div class="round-header"><i class="fas fa-flag"></i> Round ${roundNumber}</div>`;
                    
                    rounds[roundNumber].forEach(match => {
                        const isUserTeam1 = userTeams.some(team => team.id === match.team1_id);
                        const isUserTeam2 = userTeams.some(team => team.id === match.team2_id);
                        
                        // Format date if available
                        let dateInfo = '';
                        if (match.match_date) {
                            const matchDate = new Date(match.match_date);
                            dateInfo = `
                                <div class="info-item">
                                    <i class="fas fa-calendar"></i> 
                                    ${matchDate.toLocaleDateString()} 
                                    <i class="fas fa-clock" style="margin-left: 10px;"></i>
                                    ${matchDate.toLocaleTimeString()}
                                </div>
                            `;
                        }

                        if (match.venue) {
                            dateInfo += `
                                <div class="info-item">
                                    <i class="fas fa-map-marker-alt"></i> ${match.venue}
                                </div>
                            `;
                        }

                        // Score and winner info
                        let resultInfo = '';
                        if (match.status === 'completed' && match.winner_name) {
                            resultInfo = `
                                <div class="score-display">
                                    ${match.team1_score !== null ? `${match.team1_score} - ${match.team2_score}` : 'Match Completed'}
                                </div>
                                <div class="winner-display">
                                    <i class="fas fa-trophy"></i> Winner: ${match.winner_name}
                                </div>
                            `;
                        } else if (match.status === 'in_progress') {
                            resultInfo = `<div class="info-item" style="color: #ffc107;"><i class="fas fa-spinner"></i> In Progress</div>`;
                        } else if (match.status === 'scheduled') {
                            resultInfo = `<div class="info-item" style="color: #17a2b8;"><i class="fas fa-clock"></i> Scheduled</div>`;
                        }

                        const matchCard = document.createElement('div');
                        matchCard.className = 'match-card';
                        matchCard.innerHTML = `
                            <div class="teams-display">
                                <div class="team ${isUserTeam1 ? 'user-team' : ''}">${match.team1_name || 'TBD'}</div>
                                <div class="vs">VS</div>
                                <div class="team ${isUserTeam2 ? 'user-team' : ''}">${match.team2_name || 'TBD'}</div>
                            </div>
                            ${resultInfo ? `<div style="margin: 15px 0;">${resultInfo}</div>` : ''}
                            ${dateInfo ? `<div class="match-info">${dateInfo}</div>` : ''}
                        `;
                        
                        roundDiv.appendChild(matchCard);
                    });
                    
                    matchesContainer.appendChild(roundDiv);
                });
            }

            // Back to brackets button
            document.getElementById('backToBrackets').addEventListener('click', function() {
                document.getElementById('matchesSection').style.display = 'none';
                document.querySelector('.brackets-section').style.display = 'block';
            });

        let isSidebarOpen = false;

        function toggleNav() {
            const sidebar = document.getElementById("mySidebar");
            const content = document.querySelector(".dashboard-container");
            const sidebarBtn = document.querySelector(".sidebar-btn");

            if (isSidebarOpen) {
                sidebar.style.left = "-240px";  
                document.body.classList.remove("sidebar-open");
                sidebarBtn.innerHTML = "&#9776;";
            } else {
                sidebar.style.left = "0";
                document.body.classList.add("sidebar-open");
                sidebarBtn.innerHTML = "&#9776;";
            }

            isSidebarOpen = !isSidebarOpen;
        }

        // Toggle the sub-sidebar under "Team"
        function toggleSubSidebar() {
            const subSidebar = document.getElementById("subSidebar");
            const teamLink = document.querySelector(".team-link");

            // Toggle sub-sidebar visibility
            if (subSidebar.style.display === "block") {
                subSidebar.style.display = "none";
                teamLink.classList.remove("active");
            } else {
                subSidebar.style.display = "block";
                teamLink.classList.add("active");
            }
        }

        // Show the logout confirmation modal
        function showLogoutModal() {
            document.getElementById('logoutModal').style.display = 'block';
        }

        function hideLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        document.getElementById('confirmLogout').addEventListener('click', function() {
            window.location.href = '/logout';  
        });

        document.getElementById('cancelLogout').addEventListener('click', function() {
            hideLogoutModal(); 
        });

        // User profile dropdown functionality
        const userProfile = document.querySelector('.user-profile');
        const dropdown = document.querySelector('.dropdown-content');
        let hideTimeout;

        // Show dropdown when hovering profile
        userProfile.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout);
            dropdown.classList.add('show');
        });

        // Hide dropdown when leaving both profile and dropdown
        userProfile.addEventListener('mouseleave', (e) => {
            // Check if we're moving to the dropdown
            if (!dropdown.contains(e.relatedTarget)) {
                hideTimeout = setTimeout(() => {
                    dropdown.classList.remove('show');
                }, 1000);
            }
        });

        // Keep dropdown visible when hovering over it
        dropdown.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout);
        });

        // Hide dropdown when leaving it
        dropdown.addEventListener('mouseleave', (e) => {
            // Check if we're moving to the profile
            if (!userProfile.contains(e.relatedTarget)) {
                hideTimeout = setTimeout(() => {
                    dropdown.classList.remove('show');
                }, 1000);
            }
        });
        
        // Touch support for dropdown on mobile
        userProfile.addEventListener('click', (e) => {
            if (window.innerWidth <= 767) {
                e.stopPropagation();
                dropdown.classList.toggle('show');
            }
        });
        
        // Close dropdown when tapping outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 767 && 
                !userProfile.contains(e.target) && 
                dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            }
        });
        
        // Notification dropdown functionality
        function toggleNotificationForm() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
        }

        // Close notification dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('notificationDropdown');
            const bellWrapper = document.querySelector('.notification-wrapper');
            if (dropdown && !bellWrapper.contains(e.target)) {
                dropdown.style.display = "none";
            }
        });
    </script>
</body>

</html>

