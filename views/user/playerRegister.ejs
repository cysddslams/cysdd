<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Registration - SLAMS</title>
    <link rel="stylesheet" href="/styles/frontpage.css">
    <link rel="stylesheet" href="/styles/playerRegister.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
    <style>
        .document-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .document-section h4 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #8B0039;
            padding-bottom: 5px;
        }
        
        .required-doc {
            background-color: #f8f0f5;
            border-left: 4px solid #8B0039;
        }
        
        .file-input-wrapper {
            position: relative;
            margin-bottom: 15px;
        }
        
        .file-input-label {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border: 2px dashed #8B0039;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-input-label:hover {
            background: #f8f0f5;
            border-color: #6a002b;
        }
        
        .file-input-label i {
            margin-right: 10px;
            color: #8B0039;
        }
        
        .file-text {
            color: #666;
        }
        
        .file-name {
            margin-top: 5px;
            font-size: 14px;
            color: #28a745;
            font-weight: bold;
        }
        
        .info-text {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }

        .required-star {
            color: #e74c3c;
        }
        
        /* Badminton category specific styles */
        #badminton_category_group {
            display: none;
            margin-top: 15px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <main class="container">
        <div class="form-container">
            <a href="/all-teams" class="close-btn" title="Exit">&times;</a>
            <h2 class="form-title">Player Team Registration</h2>

            <!-- Player Registration Form -->
            <form action="/player-register" method="POST" enctype="multipart/form-data">
                <div class="form-columns">
                    <!-- Left Column -->
                    <div class="left-column">
                        <!-- Display team name -->
                        <div class="form-group">
                            <div class="team-name">Team: <%= teamName %></div>
                            <input type="hidden" name="team_id" value="<%= team_id %>">
                        </div>

                        <!-- Sport selection -->
                        <div class="form-group">
                            <label for="player_sport">Sport <span class="required-star">*</span></label>
                            <div class="select-wrapper">
                                <select id="player_sport" name="sports" required class="select-placeholder">
                                    <option value="" disabled selected hidden>Select a sport</option>
                                    <% sports.forEach(function(sport) { %>
                                        <option value="<%= sport.name %>" 
                                            data-limit="<%= sport.limit %>" 
                                            data-current="<%= sport.currentCount %>"
                                            <% if (sport.isBadminton) { %>data-badminton="true"<% } %>>
                                            <%= sport.name %> (<%= sport.currentCount %>/<%= sport.limit %>)
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                        </div>

                        <!-- Badminton Category (hidden by default) -->
                        <div class="form-group" id="badminton_category_group">
                            <label for="badminton_category">Badminton Category <span class="required-star">*</span></label>
                            <div class="select-wrapper">
                                <select id="badminton_category" name="badminton_category">
                                    <option value="" disabled selected hidden>Select category</option>
                                    <option value="Singles">Singles</option>
                                    <option value="Doubles">Doubles</option>
                                </select>
                            </div>
                            <div class="info-text">Please select whether you will play Singles or Doubles</div>
                        </div>

                        <!-- Personal information -->
                        <div class="form-group">
                            <label for="player_name">Full Name <span class="required-star">*</span></label>
                            <input type="text" id="player_name" name="player_name" required placeholder="Enter your full name">
                        </div>
                        
                        <div class="form-group">
                            <label for="birthdate">Birthdate <span class="required-star">*</span></label>
                            <input type="date" id="birthdate" name="birthdate" required>
                        </div>
                    
                        <div class="form-group">
                            <label for="age">Age <span class="required-star">*</span></label>
                            <input type="number" id="age" name="age" readonly placeholder="Will be calculated">
                        </div>
                    
                        <div class="form-group">
                            <label for="sex">Gender <span class="required-star">*</span></label>
                            <select name="sex" id="sex" required>
                                <option value="" disabled selected hidden>Select gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <!-- Conditional Fields based on Organization Type -->
                        <% if (organizationType === 'school') { %>
                            <div class="form-group">
                                <label for="school">School <span class="required-star">*</span></label>
                                <input type="text" id="school" name="school" required placeholder="Enter your school">
                            </div>

                            <!-- Student Type Dropdown -->
                            <div class="form-group">
                                <label for="student_type">Student Type <span class="required-star">*</span></label>
                                <div class="select-wrapper">
                                    <select name="student_type" id="student_type" required>
                                        <option value="" disabled selected hidden>Select student type</option>
                                        <option value="freshman">Freshman</option>
                                        <option value="old_student">Old Students/1st Time</option>
                                        <option value="old_player">Old Player</option>
                                        <option value="transferee">Transferee</option>
                                        <option value="working_student">Working Student</option>
                                        <option value="replacement_player">Replacement Player</option>
                                        <option value="graduating">Graduating</option>
                                    </select>
                                </div>
                                <div class="info-text">Select your student type to see recommended documents</div>
                            </div>
                        <% } else if (organizationType === 'barangay') { %>
                            <div class="form-group">
                                <label for="barangay">Barangay <span class="required-star">*</span></label>
                                <input type="text" id="barangay" name="barangay" required placeholder="Enter your barangay">
                            </div>
                        <% } %>
                    </div>

                    <!-- Right Column -->
                    <div class="right-column">
                        <% if (organizationType === 'school') { %>
                            <div class="form-group">
                                <label for="year_level">Year Level <span class="required-star">*</span></label>
                                <div class="select-wrapper">
                                    <select name="year_level" id="year_level" required>
                                        <option value="" disabled selected hidden>Select year level</option>
                                        <option value="1st Year">1st Year</option>
                                        <option value="2nd Year">2nd Year</option>
                                        <option value="3rd Year">3rd Year</option>
                                        <option value="4th Year">4th Year</option>
                                    </select>
                                </div>
                            </div>
                        <% } %>

                        <!-- Added Contact Number field -->
                        <div class="form-group">
                            <label for="contact_no">Contact Number <span class="required-star">*</span></label>
                            <input type="tel" id="contact_no" name="contact_no" required placeholder="Enter your contact number">
                        </div>

                        <!-- Document uploads section -->
                        <div id="documents-section">
                            <!-- Documents will be dynamically shown based on student type -->
                        </div>
                        
                        <div class="form-group">
                            <button type="submit">
                                <i class="fas fa-user-plus"></i> Register Player
                            </button>
                        </div>
                    </div>
                </div>

                <% if (errorMessage) { %>
                    <div class="error" style="text-align: center; margin-top: 20px;">
                        <i class="fas fa-exclamation-circle"></i> <%= errorMessage %>
                    </div>
                <% } %>
            </form>
        </div>
    </main>

    <script>
        // Document requirements mapping based on student type
        const documentRequirements = {
            freshman: ['PSA', 'COR', 'school_id', 'med_cert', 'waiver'],
            old_student: ['PSA', 'COR', 'COG', 'school_id', 'med_cert', 'waiver'],
            old_player: ['COR', 'COG', 'school_id', 'med_cert', 'waiver'],
            transferee: ['PSA', 'COR', 'TOR_previous_school', 'COG', 'school_id', 'med_cert', 'waiver'],
            working_student: ['COR', 'COG', 'COE', 'authorization_letter', 'school_id', 'med_cert', 'waiver'],
            replacement_player: ['PSA', 'COR', 'COG', 'entry_form', 'school_id', 'med_cert', 'waiver'],
            graduating: ['COR', 'COG', 'school_id', 'med_cert', 'waiver', 'certification_lack_units']
        };

        // Document labels
        const documentLabels = {
            PSA: 'PSA (Birth Certificate)',
            COR: 'COR (Certificate of Registration)',
            TOR_previous_school: 'TOR from Previous School',
            COG: 'COG (Certificate of Grades)',
            entry_form: 'Entry Form',
            COE: 'COE (Certificate of Employment)',
            authorization_letter: 'Authorization Letter',
            school_id: 'School ID',
            med_cert: 'Medical Certificate',
            waiver: 'Waiver Form',
            certification_lack_units: 'Certification of Lack of Units'
        };

        // Calculate age based on birthdate
        document.getElementById('birthdate').addEventListener('change', function() {
            const birthdate = new Date(this.value);
            const today = new Date();
            let age = today.getFullYear() - birthdate.getFullYear();
            const m = today.getMonth() - birthdate.getMonth();

            if (m < 0 || (m === 0 && today.getDate() < birthdate.getDate())) {
                age--;
            }

            document.getElementById('age').value = age;
        });

        // Handle sport selection change to show/hide badminton category
        document.getElementById('player_sport').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const isBadminton = selectedOption.dataset.badminton === 'true';
            const badmintonCategoryGroup = document.getElementById('badminton_category_group');
            const badmintonCategorySelect = document.getElementById('badminton_category');
            
            if (isBadminton) {
                badmintonCategoryGroup.style.display = 'block';
                badmintonCategorySelect.required = true;
                // Reset value when showing
                badmintonCategorySelect.value = '';
            } else {
                badmintonCategoryGroup.style.display = 'none';
                badmintonCategorySelect.required = false;
                // Clear value when hiding
                badmintonCategorySelect.value = '';
            }
            
            // Handle select placeholder appearance
            if (this.value !== "") {
                this.classList.remove('select-placeholder');
            } else {
                this.classList.add('select-placeholder');
            }
            
            // Show sport capacity warnings
            const current = parseInt(selectedOption.dataset.current);
            const limit = selectedOption.dataset.limit;
            
            if (limit !== 'No limit') {
                const remaining = parseInt(limit) - current;
                if (remaining <= 3) {
                    alert(`Warning: Only ${remaining} spot(s) remaining for ${selectedOption.text.split('(')[0].trim()}`);
                }
            }
        });

        // Show selected file names
        function setupFileInputListeners() {
            const fileInputs = document.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                input.addEventListener('change', function(e) {
                    const fileNameDiv = document.getElementById(`${this.name}-filename`);
                    if (fileNameDiv) {
                        fileNameDiv.textContent = e.target.files[0]?.name || '';
                    }
                });
            });
        }

        // Update documents section based on student type
        document.getElementById('student_type')?.addEventListener('change', function() {
            updateDocumentsSection(this.value);
        });

        function updateDocumentsSection(studentType) {
            const documentsSection = document.getElementById('documents-section');
            
            if (!studentType) {
                documentsSection.innerHTML = '<div class="info-text">Please select your student type to see recommended documents</div>';
                return;
            }

            const requiredDocs = documentRequirements[studentType] || [];
            
            let html = '<div class="document-section required-doc">';
            html += '<h4>Recommended Documents (PDF Format Only)</h4>';
            
            requiredDocs.forEach(doc => {
                html += `
                    <div class="form-group">
                        <label>${documentLabels[doc]}</label>
                        <div class="file-input-wrapper">
                            <div class="file-input-label">
                                <i class="fas fa-file-pdf"></i>
                                <span class="file-text">Click to upload ${documentLabels[doc]}</span>
                            </div>
                            <input type="file" id="${doc}" name="${doc}" accept=".pdf">
                            <div id="${doc}-filename" class="file-name"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            documentsSection.innerHTML = html;
            
            // Setup file input listeners for new elements
            setupFileInputListeners();
        }

        // Initialize form fields
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as max for birthdate
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('birthdate').setAttribute('max', today);
            
            // Add input pattern for contact number
            const contactInput = document.getElementById('contact_no');
            contactInput.setAttribute('pattern', '[0-9]{11}');
            contactInput.setAttribute('title', 'Please enter a valid 11-digit phone number');
            
            // Initialize documents section based on organization type
            <% if (organizationType === 'barangay') { %>
                setupBarangayDocuments();
            <% } else { %>
                documentsSection.innerHTML = '<div class="info-text">Please select your student type to see recommended documents</div>';
            <% } %>
            
            // Initialize badminton category field
            const sportSelect = document.getElementById('player_sport');
            if (sportSelect.value.includes('Badminton')) {
                document.getElementById('badminton_category_group').style.display = 'block';
                document.getElementById('badminton_category').required = true;
            }
        });

        // For barangay organization, show basic documents
        function setupBarangayDocuments() {
            const documentsSection = document.getElementById('documents-section');
            let html = '<div class="document-section required-doc">';
            html += '<h4>Recommended Documents (PDF Format Only)</h4>';
            
            const barangayDocs = ['PSA', 'waiver', 'med_cert'];
            const barangayLabels = {
                PSA: 'PSA (Birth Certificate)',
                waiver: 'Waiver Form',
                med_cert: 'Medical Certificate'
            };
            
            barangayDocs.forEach(doc => {
                html += `
                    <div class="form-group">
                        <label>${barangayLabels[doc]}</label>
                        <div class="file-input-wrapper">
                            <div class="file-input-label">
                                <i class="fas fa-file-pdf"></i>
                                <span class="file-text">Click to upload ${barangayLabels[doc]}</span>
                            </div>
                            <input type="file" id="${doc}" name="${doc}" accept=".pdf">
                            <div id="${doc}-filename" class="file-name"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            documentsSection.innerHTML = html;
            setupFileInputListeners();
        }

        // Form validation
        document.querySelector('form').addEventListener('submit', function(e) {
            const studentType = document.getElementById('student_type')?.value;
            <% if (organizationType === 'school') { %>
                if (!studentType) {
                    e.preventDefault();
                    alert('Please select your student type');
                    return false;
                }
            <% } %>
            
            // Check if badminton category is required but not selected
            const sportSelect = document.getElementById('player_sport');
            const badmintonCategory = document.getElementById('badminton_category');
            
            if (sportSelect.value.includes('Badminton') && !badmintonCategory.value) {
                e.preventDefault();
                alert('Please select a Badminton category (Singles or Doubles)');
                return false;
            }
            
            // Show loading state
            const submitBtn = document.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering Player...';
        });
    </script>
</body>
</html>
